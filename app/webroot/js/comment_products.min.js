/**
 * Created by nhdang on 8/16/2017.
 */
$(function () {
    //Thêm comment
    $('#btnCommentProduct').click(function () {
        var commetns = $('#inputComment').val();
        var product_id = $(this).data('product_id');
        var token = $('#token').val();
        if($.trim(commetns) != '')
        {
            $.ajax({
                url: '/commentproducts/send_post',
                type: 'post',
                dataType: 'json',
                data: {
                    comment: commetns,
                    product_id: product_id,
                    token: token
                },
                beforeSend: function () {
                    var html = '<div class="text-center" id="preSend"><i class="fa fa-spin fa-spinner orange2"></i> </div>';
                    $('#timeline-container').prepend(html);
                },
                success: function (data) {
                    if(data.status == 'success')
                    {
                        var html = insert_timelime(data['comment_id'], data['image'], data['fullname'], data['admin'], data['created'], data['comment'], 0);
                        html = html + '<div class="row"><div class="col-xs-11 col-xs-offset-1"><div class="timeline-container" id="div-reply-' + data['comment_id'] +'"></div></div><div>';
                        $('#timeline-container').prepend(html);
                        $('#inputComment').val('');
                    }
                    else if (data.status == 'notSession')
                    {
                        alert('Vui lòng đăng nhập');
                    }
                    else
                    {
                        alert('Có lỗi xảy ra,vui lòng thử lại sau');
                    }
                    $('#preSend').hide(200);
                }
            })
        }
        else
        {
            $('#inputComment').focus();
        }
    })
    //Nút trả lời
    $(document).on('click', '.btnReplyComment', function () {
        var html = '<div class="div-add-reply">\
                        <div class="col-xs-11 col-xs-offset-1" style="padding: 10px 0">\
                        <textarea class="form-control" rows="1" id="inputReply" placeholder="Trả lời ..."></textarea>\
                        <div class="text-right" style="padding-top: 10px"><button class="btn btn-info btn-mini" id="btnSendReply"><i class="fa fa-send"></i> Gửi</button></div>\
                        <div  id="preSendReply"></div> \
                        </div>\
                    </div>';
        var comment_product_id = $(this).data('id');
        $('.div-product-reply').html('');
        $('#div-product-reply-' + comment_product_id).html(html);
        $('#btnSendReply').data('id', comment_product_id);
        $('#inputReply').focus();
    });
    //Nút gửi trả lời
    $(document).on('click', '#btnSendReply', function () {
        var id = $(this).data('id');
        var reply = $('#inputReply').val();
        if($.trim(reply) != '')
        {
            $.ajax({
                url: '/commentproductreplies/send_reply',
                type: 'post',
                dataType: 'json',
                data: {
                    reply: reply,
                    id: id
                },
                beforeSend: function () {
                    var html = '<div class="text-center"><i class="fa fa-spin fa-spinner orange2"></i> </div>';
                    $('#preSendReply').prepend(html);
                },
                success: function(data)
                {
                    if(data.status == 'success')
                    {
                        var html = insert_timelime_reply(data['reply_id'], data['image'], data['fullname'], data['admin'], data['created'], data['reply'], 0);
                        $('#div-reply-' + id).prepend(html);
                        $('#inputReply').val('');
                    }
                    else if (data.status == 'notSession')
                    {
                        alert('Vui lòng đăng nhập');
                    }
                    else
                    {
                        alert('Có lỗi xảy ra,vui lòng thử lại sau');
                    }
                    $('#preSendReply').hide(200);
                    $('.div-product-reply').html('');
                }
            })
        }
        else
        {
            $('#inputReply').focus()
        }
    });
    //Nút like trả lời
    $(document).on('click', '.btnLikeReply', function () {
        var id = $(this).data('id_reply');
        $.ajax({
            url: '/commentproductreplies/like',
            type: 'post',
            dataType: 'json',
            data: {
                'reply_id': id
            },
            success: function (data) {
                if(data.status == 'success')
                {
                    $('#sum-like-reply-' + id).html(data.like);
                }
                else if(data.status == 'notSession')
                {
                    alert('Vui lòng đăng nhập');
                }
            }
        })
    })
    //Nút like comment
    $(document).on('click', '.btnLikeComment', function () {
        var id = $(this).data('id_comment');
        $.ajax({
            url: '/commentproducts/like',
            type: 'post',
            dataType: 'json',
            data: {
                'comment_id': id
            },
            success: function (data) {
                if(data.status == 'success')
                {
                    $('#sum-like-comment-' + id).html(data.like);
                }
                else if(data.status == 'notSession')
                {
                    alert('Vui lòng đăng nhập');
                }
            }
        })
    })
    //Load thêm comment
    $(document).on('click', '#a-more-comment', function () {
        var page = $(this).data('page');
        var post_id = $(this).data('post_id');
        $('#div-pre-more-comment').html('<i class="fa fa-spin fa-spinner orange2"></i>');
        load_comment(page, post_id);
        $('#div-pre-more-comment').html('');
    })
    //Function
})
function load_comment(page, product_id) {
    $.ajax({
        url: '/commentproducts/get_comment',
        type: 'post',
        dataType: 'json',
        data: {
            page: page,
            product_id: product_id
        },
        success: function (dt) {
            if(dt.data != null)
            {
                var data = dt.data;
                var i = 0;
                var sum = data.length;
                for(i; i < sum; i++)
                {
                    $('#timeline-container').append(insert_timelime(data[i]['id'], data[i]['image'], data[i]['fullname'], data[i]['admin'], data[i]['created'], data[i]['comment'], data[i]['like']))
                    $('#timeline-container').append('<div class="row"><div class="col-xs-11 col-xs-offset-1"><div class="timeline-container" id="div-reply-' + data[i]['id'] +'"></div></div><div>')
                    if(data[i]['reply'] != null)
                    {
                        var j = 0;
                        var html = '';
                        var sum_reply = data[i]['reply'].length;
                        for(j; j < sum_reply; j++)
                        {
                            var reply = data[i]['reply'];
                            html = html + insert_timelime_reply(reply[j]['reply_id'], reply[j]['image'], reply[j]['fullname'], reply[j]['admin'], reply[j]['created'], reply[j]['reply'], reply[j]['like']);
                        }
                        $('#div-reply-' + data[i]['id']).html(html);
                        // if(data[i]['sum_remain_reply'] > 0)
                        // {
                        //     $('#div-reply-' + data[i]['id']).append('<div class="text-center"><a href="javascript: void(0)" id="a-more-reply" data-page_reply="2" data-comment_id="' + data[i]['id'] + '">Xem thêm +</a></div>');
                        // }
                    }
                }
                if(dt.sum_remain > 0)
                {
                    $('#div-more-comment').html('<a href="javascript: void(0)" id="a-more-comment" data-page="' + (page + 1) + '" data-post_id="' + product_id + '">Xem thêm +</a>')
                }
                else
                {
                    $('#div-more-comment').html('');
                }

            }
        },
        async: false
    })
};
function insert_timelime(id, image, fullname, admin, created, comment, like) {
    var html_admin = '';
    if(admin == true)
    {
        html_admin = '<span class="label label-warning">Quản trị</span>';
    }
    var time_line = '<div class="timeline-items">\
                            <div class="timeline-item clearfix">\
                                <div class="timeline-info">\
                                    <img src="/img/members/' + image + '" width="42px" height="42px">\
                                </div>\
                                <div class="widget-box transparent">\
                                    <div class="widget-header widget-header-small">\
                                        <h5 class="widget-title smaller">\
                                            <a href="javascript: void(0)" class="blue">' + fullname + '</a>\
                                            <span class="grey">' + html_admin + '</span>\
                                        </h5>\
                                        <span class="widget-toolbar no-border">\
                                            <i class="ace-icon fa fa-clock-o bigger-110"></i>\
                                            ' + created + '\
                                        </span>\
                                    </div>\
                                    <div class="widget-body">\
                                        <div class="widget-main">\
                                            ' + comment + '\
                                            </div>\
                                            <div class="widget-toolbox clearfix">\
                                                <div class="pull-right action-buttons">\
                                                    <a data-id="' + id + '" class="btnReplyComment" href="javascript: void(0)" title="Trả lời">\
                                                        <i class="ace-icon fa fa-mail-reply blue bigger-130"></i>\
                                                    </a> | \
                                                    <a data-id_comment="' + id + '" href="javascript: void(0)" class="btnLikeComment" title="Thích">\
                                                        <i class="ace-icon fa fa-thumbs-o-up blue bigger-130"></i>\
                                                    </a>\
                                                    <span id="sum-like-comment-' + id + '">' +  like + '</span> | \
                                                    ' + add_share() +'\
                                                </div>\
                                            </div>\
                                            <div class="div-product-reply" id="div-product-reply-' + id + '"></div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>';<!-- /.timeline-items -->
    return time_line;
}
function insert_timelime_reply(id, image, fullname, admin, created, comment, like) {
    var html_admin = '';
    if(admin == true)
    {
        html_admin = '<span class="label label-warning">Quản trị</span>';
    }
    var time_line = '<div class="timeline-items">\
                            <div class="timeline-item clearfix">\
                                <div class="timeline-info">\
                                    <img src="/img/members/' + image + '" width="42px" height="42px">\
                                </div>\
                                <div class="widget-box transparent">\
                                    <div class="widget-header widget-header-small">\
                                        <h5 class="widget-title smaller">\
                                            <a href="javascript: void(0)" class="blue">' + fullname + '</a>\
                                            <span class="grey">' + html_admin + '</span>\
                                        </h5>\
                                        <span class="widget-toolbar no-border">\
                                            <i class="ace-icon fa fa-clock-o bigger-110"></i>\
                                            ' + created + '\
                                        </span>\
                                    </div>\
                                    <div class="widget-body">\
                                        <div class="widget-main">\
                                            ' + comment + '\
                                            </div>\
                                            <div class="widget-toolbox clearfix">\
                                                <div class="pull-right action-buttons">\
                                                    <a data-id_reply="' + id + '" class="btnLikeReply" href="javascript: void(0)" title="Thích">\
                                                        <i class="ace-icon fa fa-thumbs-o-up blue bigger-130"></i>\
                                                    </a>\
                                                    <span id="sum-like-reply-' + id + '">' +  like + '</span> | \
                                                    ' + add_share() +'\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>';<!-- /.timeline-items -->
    return time_line;
}
function add_share() {
    var url_facebook = 'https://www.facebook.com/sharer?u=' + window.location;
    var url_google = 'https://plus.google.com/share?url=' + window.location;
    var html = '<div class="inline pos-rel">\
        <a href="javascript: void(0)" class="dropdown-toggle" data-toggle="dropdown" data-position="auto" title="Chia sẽ">\
        <i class="ace-icon fa fa-share green bigger-125"></i>\
        </a>\
        <ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">\
        <li>\
        <a href="' + url_facebook + '" target="_blank" class="tooltip-info" data-rel="tooltip" title="Facebook" data-original-title="Facebook">\
        <span class="blue">\
        <i class="ace-icon fa fa-facebook"></i>\
        </span>\
        </a>\
        </li>\
        <li>\
        <a href="' + url_google + '" target="_blank" class="tooltip-error" data-rel="tooltip" title="Google plus" data-original-title="Google Plus">\
        <span class="red">\
        <i class="ace-icon fa fa-google-plus"></i>\
        </span>\
        </a>\
        </li>\
        </ul>\
        </div>';
    return html;
}